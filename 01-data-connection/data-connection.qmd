---
title: "Data Connectivity with Managed Credentials"
format:
  html:
    toc: true
    toc-location: left
    anchor-sections: true
    code-fold: false
    code-overflow: wrap
    code-summary: "Show Code"
    code-tools: true
    code-link: true
editor: visual
editor_options: 
  chunk_output_type: console
  canonical: true
html-table-processing: none
---

## General Workshop Activity Notes

Welcome to the Workbench Managed Credentials activity! A few points relevant to this activity:

1.  This Activity is a Quarto document, presented by default in the Visual Editor for readability
2.  Run each code chunk interactively rather than rendering the document
3.  Run the chunk by either clicking the green Play Button â–¶ï¸Ž in the chunk's top right corner, or use the cmd+enter keyboard shortcut
4.  We'll work through these activities mostly as a group, code-along style because our focus in this workshop is less about code development and more about around processes, tools, and learning concepts. We can best teach this if we do it together!
5.  **Where's my output?** Are you a `Chunk Output Inline` kind of person? Sorry. For the Workshop, it's set by default to go the console because it requires less scrolling up/down to talk through things. If you hate it, you can change it. ðŸ˜‰

------------------------------------------------------------------------

## Goals

The goals of this activity are to:

-   connect to an AWS resource using Workbench-Managed AWS Credentials.
-   publish to Posit Connect using the Posit Publisher extension
-   use a Connect OAuth integration in deployment for secure access to AWS resources

**Security Note**: Never hardcode credentials in your code!

## Setup

```{r}
#| label: load required packages

library(paws)
library(tidyverse)

```

## Task 1 - Verify credentials

If you started your development session with AWS Managed Credentials, Workbench has already populated your session with your AWS credentials using a short-lived access token. But don't worry, Workbench is managing the refresh of your token so you can work uninterrupted! AWS SDKs and the AWS CLI detect this token automatically, so connections will *just work*. âœ¨

The `paws` package provides an R-interface to the AWS SDK. We'll use this to interact with our AWS resources.

Check it out:

```{r}
#| label: verify-credentials

# STS is the AWS Security Token Service
# We'll make a client service to interact with STS
# Notice we don't have to manually specify any credential information!
svc <- paws::sts()

# Use the client to get information about your current AWS identity
svc$get_caller_identity()
```

You should see output similar to:

``` bash
$UserId
[1] "AROAXXXXXXXXXXXXXXXXX:user.name"

$Account
[1] "123456789012"

$Arn
[1] "arn:aws:sts::123456789012:assumed-role/example-role-name/user.name"
```

## Task 2 - Read data from S3

Now let's read our project data from an AWS S3 bucket using our managed credentials.

```{r}
#| label: read-s3

# Make a client service to interact with S3
# Notice we don't have to manually specify any credential information!
s3_client <- paws::s3()

# Bucket information
bucket_name <- "ptd-demo-bucket"
file_key <- "posit_cola_sales_data.csv"

# Read the data from S3

response <- s3_client$get_object(
  Bucket = bucket_name,
  Key = file_key
)

data <- read_csv(rawToChar(response$Body))

data

```
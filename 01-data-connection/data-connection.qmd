---
title: "Data Connectivity with Managed Credentials"
format:
  html:
    toc: true
    toc-location: left
    anchor-sections: true
    code-fold: false
    code-overflow: wrap
    code-summary: "Show Code"
    code-tools: true
    code-link: true
editor: visual
editor_options: 
  chunk_output_type: console
  canonical: true
html-table-processing: none
---

## General Workshop Activity Notes

Welcome to the Workbench Managed Credentials activity! A few points relevant to this activity:

1.  This Activity is a Quarto document, presented by default in the Visual Editor for readability
2.  Run each code chunk interactively rather than rendering the document
3.  Run the chunk by either clicking the green Play Button â–¶ï¸Ž in the chunk's top right corner, or use the cmd+enter keyboard shortcut
4.  We'll work through these activities mostly as a group, code-along style because our focus in this workshop is less about code development and more about around processes, tools, and learning concepts. We can best teach this if we do it together!
5.  **Where's my output?** Are you a `Chunk Output Inline` kind of person? Sorry. For the Workshop, it's set by default to go the console because it requires less scrolling up/down to talk through things. If you hate it, you can change it. ðŸ˜‰

------------------------------------------------------------------------

## Goals

The goals of this activity are to:

-   connect to an AWS resource using Workbench-Managed AWS Credentials.
-   publish to Posit Connect using the Posit Publisher extension
-   use a Connect OAuth integration in deployment for secure access to AWS resources

**Security Note**: Never hardcode credentials in your code!

## Setup

```{r}
#| label: load required packages

library(paws)
library(tidyverse)
library(connectapi)

```

## Task 1 - Verify credentials in Workbench

If you started your development session with AWS Managed Credentials, Workbench has already populated your session with your AWS credentials using a short-lived access token. But don't worry, Workbench is managing the refresh of your token so you can work uninterrupted! AWS SDKs and the AWS CLI detect this token automatically, so connections will *just work*. âœ¨

The `paws` package provides an R-interface to the AWS SDK. We'll use this to interact with our AWS resources.

Check it out:

```{r}
#| label: verify-credentials
#| eval: false

# (Workshop note: we set `eval: false` because we just want to run this interactively. We don't want it to run when we publish this report to Connect)

# STS is the AWS Security Token Service
# We'll make a client service to interact with STS
# Notice we don't have to manually specify any credential information!
svc <- paws::sts()

# Use the client to get information about your current AWS identity
svc$get_caller_identity()
```

You should see output similar to:

``` bash
$UserId
[1] "AROAXXXXXXXXXXXXXXXXX:user.name"

$Account
[1] "123456789012"

$Arn
[1] "arn:aws:sts::123456789012:assumed-role/example-role-name/user.name"
```

## Task 1.5 - Fetch credentials when deployed to Connect

In Workbench, credentials "just work" because you are working in your own interactive session running in a distinct R process and environment.

When content runs on Connect, many users might share the runtime environment for their own sessions. So for security, the target system's credential can't be stored ambiently in the environment. There's a credential fetch process we'll perform to trade a non-sensitive session token that is available in the environment for the target credential we want.

On Connect, the context is different. Many users might share the same runtime environment. For security, a powerful credential like an OAuth access token can't be stored directly in that shared space. Instead, our code performs a secure exchange: it trades a temporary **session token** (which is safely available) for the powerful **target credential**. This makes the credential available only in the content session that the user is running.

Here's how we exchange the content session token for AWS credentials:

```{r}
#| label: connect-credentials

# Exchange token for AWS credentials when running on Connect
if (Sys.getenv("POSIT_PRODUCT") == "CONNECT") {
  client <- connectapi::connect()
  # exchange the session token for the AWS credentials
  credentials <- get_aws_content_credentials(client)
  
  # set the credentials as environment variables for the session
  Sys.setenv(
    AWS_ACCESS_KEY_ID = credentials$access_key_id,
    AWS_SECRET_ACCESS_KEY = credentials$secret_access_key,
    AWS_SESSION_TOKEN = credentials$session_token,
    AWS_REGION = "us-east-2"
  )
}
```

## Task 2 - Read data from S3

Now let's read our project data from an AWS S3 bucket using our managed credentials.

```{r}
#| label: read-s3

# Make a client service to interact with S3
# Notice we don't have to manually specify any credential information!
s3_client <- paws::s3()

# Bucket information
bucket_name <- "ptd-demo-bucket"
file_key <- "posit_cola_sales_data.csv"

# Read the data from S3

response <- s3_client$get_object(
  Bucket = bucket_name,
  Key = file_key
)

data <- read_csv(rawToChar(response$Body))

data

```

## Task 3 - Publish to Posit Connect

Using the Posit Publisher extension, let's publish this to Connect and see our OAuth Credentials at work in this environment. 

1. **Deployment** > **Create New Deployment** > Select `data-connection.qmd` as the entrypoint file > **Publish document with source code** > enter a title > press **Enter** to select `pub.workshop.posit.team` as the destination
2. (One time only) Add your Posit Connect API key
3. Configure deployment options
4. Deploy
